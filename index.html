<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DnD Alchemy Tracker</title>
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; padding: 16px; max-width: 980px; margin-inline: auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .muted { color: #666; font-size: 13px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input, select, button, textarea { font-size: 16px; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .btn { background: #f5f5f5; }
    .btn-primary { background: #1f6feb; border-color: #1f6feb; color: white; }
    .btn-danger { background: #d73a49; border-color: #d73a49; color: white; }
    .small { font-size: 13px; padding: 8px 10px; }
    img { max-width: 180px; width: 100%; height: auto; border-radius: 12px; border: 1px solid #eee; }
    .grid2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 760px) { .grid2 { grid-template-columns: 1fr 1fr; } }
    .effects { display: grid; gap: 8px; margin-top: 10px; }
    .effect-line { display: flex; gap: 8px; align-items: center; }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; background: #fafafa; white-space: nowrap; }
    .effect-text { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: #fff; }
    .hidden { color: transparent; text-shadow: 0 0 10px rgba(0,0,0,0.6); user-select: none; }
    .ok { color: #0a7a0a; font-weight: 700; }
    .warn { color: #8a5a00; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .list-wrap { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .tag-btn { border: 1px solid #ddd; background: #fff; border-radius: 999px; padding: 8px 10px; }
    .tag-btn:hover { background: #f7f7f7; }
  </style>
</head>
<body>
  <h1>DnD Alchemy Tracker</h1>
  <div class="muted">
    Read-only app backed by Supabase. Reveals and “My Ingredients” list are stored locally on this device.
  </div>

  <div class="card">
    <div class="row">
      <button class="btn-primary" id="refreshBtn">Refresh Ingredient List</button>
      <span class="muted" id="statusText">Not loaded yet.</span>
    </div>
    <div class="muted" style="margin-top:8px;">
      You can add ingredients in Supabase, then click Refresh here to pull updates.
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Add by ID (no browsing)</div>
      <div class="row">
        <input id="idInput" inputmode="numeric" placeholder="Enter Ingredient ID (e.g. 9000)" />
        <button class="btn-primary" id="addToListBtn">Add to My List</button>
        <button class="btn" id="loadBtn">Load</button>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        Add saves it to the local list. Load shows the card without saving.
      </div>

      <div style="margin-top:14px; font-weight:700;">My Ingredients</div>
      <div class="muted">Tap an ID to open it. This list is only what the player has added.</div>
      <div class="list-wrap" id="myListWrap"></div>
      <div class="row" style="margin-top:10px;">
        <button class="btn-danger small" id="clearMyListBtn">Clear My List</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Mixing (from My List)</div>
      <div class="muted">
        Pick two from My Ingredients. “Check Shared” shows shared effects. If the table says the brew succeeded, click “Reveal Shared”.
      </div>
      <div class="row" style="margin-top:10px;">
        <select id="mixA" style="min-width: 280px;"></select>
        <select id="mixB" style="min-width: 280px;"></select>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn-primary" id="checkSharedBtn">Check Shared</button>
        <button class="btn" id="revealSharedBtn" disabled>Reveal Shared</button>
      </div>
      <div id="sharedResult" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="card" id="ingredientCard" style="display:none;">
    <div class="row" style="align-items:flex-start;">
      <div>
        <img id="ingImage" alt="Ingredient image" />
      </div>
      <div style="flex:1; min-width: 240px;">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Ingredient</div>
            <div style="font-size:18px; font-weight:700;" id="ingName"></div>
            <div class="muted">ID: <span id="ingId" class="mono"></span></div>
            <div class="muted">Rarity: <span id="ingRarity"></span></div>
          </div>
          <div>
            <button class="btn small" id="revealRandomBtn">Reveal Random Hidden</button>
            <button class="btn-danger small" id="resetRevealsBtn">Reset Reveals</button>
          </div>
        </div>

        <div class="effects" id="effectsList"></div>

        <div class="muted" style="margin-top:10px;">
          Bruised penalties and Medicine checks happen at the table. This app only tracks what you revealed.
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700; margin-bottom:8px;">Backup (Export / Import reveals and My List)</div>
    <div class="muted">Everything is stored on this device. Export lets you move progress to another phone if needed.</div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="exportBtn">Export</button>
      <button class="btn" id="importBtn">Import</button>
      <button class="btn-danger" id="wipeBtn">Wipe All Local Data</button>
    </div>
    <textarea id="saveBox" rows="6" style="width:100%; margin-top:10px;" placeholder="Exported JSON appears here. Paste JSON here to import."></textarea>
  </div>

<script>
  // Supabase config (your values)
  const SUPABASE_URL = "https://yjelzojkirlzdnwftupz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqZWx6b2praXJsemRud2Z0dXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTk0MTEsImV4cCI6MjA4NTkzNTQxMX0.5TCIyj5cAUlCAmNc2yBOIdpfNoN4NLqOOfcnBVbCzZA";

  const REST_BASE = `${SUPABASE_URL}/rest/v1`;
  const INGREDIENTS_ENDPOINT = `${REST_BASE}/ingredients?select=id,name,effect_1,effect_2,effect_3,effect_4,image_path,rarity,notes&order=id.asc`;
  const INGREDIENT_BY_ID = (id) => `${REST_BASE}/ingredients?select=id,name,effect_1,effect_2,effect_3,effect_4,image_path,rarity,notes&id=eq.${encodeURIComponent(id)}&limit=1`;
  const PUBLIC_STORAGE_BASE = `${SUPABASE_URL}/storage/v1/object/public/`;

  const LOCAL_KEY = "alchemy_local_v2"; // contains reveals + myList

  function loadLocal() {
    const raw = localStorage.getItem(LOCAL_KEY);
    if (!raw) return { reveals: {}, myList: [] };
    try {
      const parsed = JSON.parse(raw);
      return {
        reveals: (parsed && typeof parsed.reveals === "object" && parsed.reveals) ? parsed.reveals : {},
        myList: Array.isArray(parsed?.myList) ? parsed.myList.map(String) : []
      };
    } catch {
      return { reveals: {}, myList: [] };
    }
  }

  function saveLocal() {
    localStorage.setItem(LOCAL_KEY, JSON.stringify(LOCAL));
  }

  let LOCAL = loadLocal();
  let REVEALS = LOCAL.reveals;
  let MY_LIST = LOCAL.myList;

  let INGREDIENTS = []; // all rows (for lookup by ID)
  let ING_BY_ID = {};   // id -> row

  const el = (id) => document.getElementById(id);

  function headers() {
    return {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    };
  }

  async function fetchIngredients() {
    el("statusText").textContent = "Loading from Supabase...";
    try {
      const res = await fetch(INGREDIENTS_ENDPOINT, { headers: headers() });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }
      const rows = await res.json();
      INGREDIENTS = rows;
      ING_BY_ID = {};
      for (const r of rows) {
        const idStr = String(r.id);
        ING_BY_ID[idStr] = r;
        if (!REVEALS[idStr]) REVEALS[idStr] = [false, false, false, false];
      }
      saveLocal();
      renderMyList();
      fillMixDropdownsFromMyList();
      el("statusText").innerHTML = `<span class="ok">Loaded ${rows.length} ingredients.</span>`;
    } catch (err) {
      el("statusText").innerHTML = `<span class="err">Failed to load: ${escapeHtml(String(err.message || err))}</span>`;
      console.error(err);
    }
  }

  async function fetchOneIngredient(idStr) {
    const res = await fetch(INGREDIENT_BY_ID(idStr), { headers: headers() });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    const rows = await res.json();
    return rows?.[0] || null;
  }

  function getImageUrl(image_path) {
    if (!image_path) return "";
    return `${PUBLIC_STORAGE_BASE}${image_path}`;
  }

  function renderIngredient(idStr) {
    const row = ING_BY_ID[idStr];
    if (!row) {
      alert("Unknown ID. Refresh list, or add it in Supabase.");
      return;
    }

    el("ingredientCard").style.display = "block";
    el("ingName").textContent = row.name || "";
    el("ingId").textContent = idStr;
    el("ingRarity").textContent = row.rarity || "Unknown";

    const imgUrl = getImageUrl(row.image_path);
    el("ingImage").src = imgUrl || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512'%3E%3Crect width='100%25' height='100%25' fill='%23f2f2f2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666' font-size='22'%3ENo image%3C/text%3E%3C/svg%3E";

    const effects = [row.effect_1, row.effect_2, row.effect_3, row.effect_4].map(v => v || "");
    const revealed = REVEALS[idStr] || [false,false,false,false];

    const list = el("effectsList");
    list.innerHTML = "";

    effects.forEach((eff, idx) => {
      const line = document.createElement("div");
      line.className = "effect-line";

      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = `Effect ${idx+1}`;

      const text = document.createElement("div");
      text.className = "effect-text";
      text.textContent = eff || "(empty)";
      if (!revealed[idx]) text.classList.add("hidden");

      const btn = document.createElement("button");
      btn.className = "btn small";
      btn.textContent = revealed[idx] ? "Revealed" : "Reveal";
      btn.disabled = revealed[idx];
      btn.addEventListener("click", () => {
        REVEALS[idStr][idx] = true;
        saveLocal();
        renderIngredient(idStr);
      });

      line.appendChild(pill);
      line.appendChild(text);
      line.appendChild(btn);
      list.appendChild(line);
    });

    el("revealRandomBtn").onclick = () => {
      const hidden = [];
      for (let i = 0; i < 4; i++) if (!REVEALS[idStr][i]) hidden.push(i);
      if (hidden.length === 0) return;
      const pick = hidden[Math.floor(Math.random() * hidden.length)];
      REVEALS[idStr][pick] = true;
      saveLocal();
      renderIngredient(idStr);
    };

    el("resetRevealsBtn").onclick = () => {
      REVEALS[idStr] = [false,false,false,false];
      saveLocal();
      renderIngredient(idStr);
    };
  }

  function clearCard() {
    el("ingredientCard").style.display = "none";
    el("sharedResult").innerHTML = "";
    el("revealSharedBtn").disabled = true;
  }

  function renderMyList() {
    const wrap = el("myListWrap");
    wrap.innerHTML = "";

    const unique = Array.from(new Set(MY_LIST.map(String)));
    unique.sort((a,b) => Number(a) - Number(b));
    MY_LIST = unique;
    LOCAL.myList = MY_LIST;
    saveLocal();

    if (MY_LIST.length === 0) {
      const span = document.createElement("div");
      span.className = "muted";
      span.textContent = "No ingredients added yet.";
      wrap.appendChild(span);
      return;
    }

    for (const idStr of MY_LIST) {
      const btn = document.createElement("button");
      btn.className = "tag-btn";
      const name = ING_BY_ID[idStr]?.name;
      btn.textContent = name ? `${idStr} - ${name}` : idStr;
      btn.addEventListener("click", () => renderIngredient(idStr));

      const remove = document.createElement("button");
      remove.className = "tag-btn";
      remove.textContent = `Remove ${idStr}`;
      remove.addEventListener("click", () => {
        MY_LIST = MY_LIST.filter(x => String(x) !== String(idStr));
        LOCAL.myList = MY_LIST;
        saveLocal();
        renderMyList();
        fillMixDropdownsFromMyList();
      });

      wrap.appendChild(btn);
      wrap.appendChild(remove);
    }
  }

  function fillMixDropdownsFromMyList() {
    const a = el("mixA");
    const b = el("mixB");
    const ids = MY_LIST.slice();

    const opts = ids.map(idStr => {
      const name = ING_BY_ID[idStr]?.name || "";
      const label = name ? `${idStr} - ${name}` : idStr;
      return `<option value="${escapeHtml(idStr)}">${escapeHtml(label)}</option>`;
    }).join("");

    a.innerHTML = opts;
    b.innerHTML = opts;

    if (ids.length >= 2) {
      a.value = ids[0];
      b.value = ids[1];
    }
  }

  function computeShared(aId, bId) {
    const a = ING_BY_ID[aId];
    const b = ING_BY_ID[bId];
    if (!a || !b) return [];

    const aEffects = [a.effect_1, a.effect_2, a.effect_3, a.effect_4].filter(Boolean);
    const bEffects = new Set([b.effect_1, b.effect_2, b.effect_3, b.effect_4].filter(Boolean));
    return aEffects.filter(e => bEffects.has(e));
  }

  function revealShared(aId, bId, shared) {
    const a = ING_BY_ID[aId];
    const b = ING_BY_ID[bId];
    if (!a || !b) return;

    const aEffects = [a.effect_1, a.effect_2, a.effect_3, a.effect_4];
    const bEffects = [b.effect_1, b.effect_2, b.effect_3, b.effect_4];

    if (!REVEALS[aId]) REVEALS[aId] = [false,false,false,false];
    if (!REVEALS[bId]) REVEALS[bId] = [false,false,false,false];

    for (let i = 0; i < 4; i++) {
      if (shared.includes(aEffects[i])) REVEALS[aId][i] = true;
      if (shared.includes(bEffects[i])) REVEALS[bId][i] = true;
    }
    saveLocal();
  }

  function exportAll() {
    const payload = { reveals: REVEALS, myList: MY_LIST };
    el("saveBox").value = JSON.stringify(payload, null, 2);
  }

  function importAll() {
    try {
      const parsed = JSON.parse(el("saveBox").value);
      if (!parsed || typeof parsed !== "object") throw new Error("Not an object");
      REVEALS = (parsed.reveals && typeof parsed.reveals === "object") ? parsed.reveals : {};
      MY_LIST = Array.isArray(parsed.myList) ? parsed.myList.map(String) : [];
      LOCAL = { reveals: REVEALS, myList: MY_LIST };
      saveLocal();
      renderMyList();
      fillMixDropdownsFromMyList();
      alert("Imported.");
    } catch {
      alert("Invalid JSON.");
    }
  }

  function wipeAll() {
    if (!confirm("Wipe all local reveals and My List on this device?")) return;
    LOCAL = { reveals: {}, myList: [] };
    REVEALS = LOCAL.reveals;
    MY_LIST = LOCAL.myList;
    saveLocal();
    clearCard();
    renderMyList();
    fillMixDropdownsFromMyList();
    alert("Wiped.");
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[c]));
  }

  // Events
  el("refreshBtn").addEventListener("click", fetchIngredients);

  el("loadBtn").addEventListener("click", () => {
    const idStr = el("idInput").value.trim();
    if (!idStr) return;
    renderIngredient(idStr);
  });

  el("addToListBtn").addEventListener("click", async () => {
    const idStr = el("idInput").value.trim();
    if (!idStr) return;

    // Prefer cache, but verify against Supabase if not loaded or missing.
    if (!ING_BY_ID[idStr]) {
      try {
        const row = await fetchOneIngredient(idStr);
        if (!row) {
          alert("That ID does not exist in the database.");
          return;
        }
        ING_BY_ID[idStr] = row;
        // Keep reveals in sync
        if (!REVEALS[idStr]) REVEALS[idStr] = [false,false,false,false];
        saveLocal();
      } catch (e) {
        alert("Could not verify that ID. Try Refresh Ingredient List first.");
        return;
      }
    }

    if (!MY_LIST.includes(idStr)) {
      MY_LIST.push(idStr);
      LOCAL.myList = MY_LIST;
      saveLocal();
      renderMyList();
      fillMixDropdownsFromMyList();
    }

    renderIngredient(idStr);
  });

  el("clearBtn").addEventListener("click", clearCard);

  el("clearMyListBtn").addEventListener("click", () => {
    if (!confirm("Clear My Ingredients list on this device?")) return;
    MY_LIST = [];
    LOCAL.myList = MY_LIST;
    saveLocal();
    renderMyList();
    fillMixDropdownsFromMyList();
  });

  let lastMix = { a: null, b: null, shared: [] };

  el("checkSharedBtn").addEventListener("click", () => {
    const aId = el("mixA").value;
    const bId = el("mixB").value;

    if (!aId || !bId) {
      el("sharedResult").innerHTML = `<div class="warn">Add at least two ingredients to My List first.</div>`;
      el("revealSharedBtn").disabled = true;
      return;
    }

    if (aId === bId) {
      el("sharedResult").innerHTML = `<div class="warn">Choose two different ingredients.</div>`;
      el("revealSharedBtn").disabled = true;
      return;
    }

    const shared = computeShared(aId, bId);
    lastMix = { a: aId, b: bId, shared };

    if (shared.length === 0) {
      el("sharedResult").innerHTML = `<div class="warn">No shared effects. This mix would fail (no potion).</div>`;
      el("revealSharedBtn").disabled = true;
      return;
    }

    el("sharedResult").innerHTML = `
      <div class="ok">Shared effects found:</div>
      <ul>${shared.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
    `;
    el("revealSharedBtn").disabled = false;
  });

  el("revealSharedBtn").addEventListener("click", () => {
    if (!lastMix.a || !lastMix.b) return;
    revealShared(lastMix.a, lastMix.b, lastMix.shared);
    el("sharedResult").innerHTML += `<div class="ok">Revealed shared effects on both ingredients.</div>`;
  });

  el("exportBtn").addEventListener("click", exportAll);
  el("importBtn").addEventListener("click", importAll);
  el("wipeBtn").addEventListener("click", wipeAll);

  // Init
  fetchIngredients();
  renderMyList();
  fillMixDropdownsFromMyList();
</script>
</body>
</html>
