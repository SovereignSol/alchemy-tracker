<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Field Alchemy Notes</title>
  <style>
    :root{
      --ink:#2a1f16;
      --ink2:rgba(42,31,22,0.72);
      --paper:#f6f0e3;
      --paper2:#efe5d3;
      --edge:#d9c8aa;
      --seal:#7a3e1f;
      --good:#1f7a3a;
      --warn:#8a5a00;
      --bad:#8b1d2c;
      --shadow: 0 16px 40px rgba(0,0,0,0.18);
      --shadow2: 0 10px 24px rgba(0,0,0,0.14);
      --radius: 16px;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(122,62,31,0.08), transparent 60%),
        radial-gradient(900px 520px at 90% 20%, rgba(31,122,58,0.06), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      font-family: "Segoe Print","Bradley Hand","Comic Sans MS",cursive,system-ui;
      letter-spacing: 0.2px;
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 16px; }

    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    h1{
      margin:0;
      font-size: 26px;
      line-height:1.05;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }

    .sub{ margin-top:4px; color:var(--ink2); font-size:14px; }

    .card{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--edge);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      margin: 12px 0;
      backdrop-filter: blur(2px);
    }

    .grid2{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 760px){ .grid2{ grid-template-columns: 1fr 1fr; } }

    .row{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }

    .label{ font-weight: 700; font-size: 16px; margin-bottom: 8px; }

    input, select, button, textarea{
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,0.75);
      color: var(--ink);
      outline: none;
      box-shadow: 0 2px 0 rgba(0,0,0,0.04) inset;
      font-family: inherit;
    }

    input::placeholder{ color: rgba(42,31,22,0.45); }

    button{
      cursor:pointer;
      user-select:none;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    button:active{ transform: translateY(1px); }

    .btn{ background: rgba(255,255,255,0.8); }

    .btn-primary{
      background: linear-gradient(180deg, rgba(122,62,31,0.92), rgba(122,62,31,0.78));
      color: #fff7ee;
      border-color: rgba(122,62,31,0.55);
      box-shadow: 0 10px 22px rgba(122,62,31,0.18);
    }
    .btn-primary:hover{ box-shadow: 0 14px 28px rgba(122,62,31,0.22); }

    .btn-quiet{
      background: rgba(255,255,255,0.65);
      color: rgba(42,31,22,0.78);
    }

    .btn-danger{
      background: rgba(139,29,44,0.10);
      border-color: rgba(139,29,44,0.35);
      color: var(--bad);
    }

    .small{ padding: 8px 10px; font-size: 14px; border-radius: 12px; }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--edge);
      background: rgba(255,255,255,0.68);
      color: rgba(42,31,22,0.78);
      font-size: 13px;
    }

    .pill-rare{ border-color: rgba(31,122,58,0.35); background: rgba(31,122,58,0.08); }
    .pill-common{ border-color: rgba(122,62,31,0.35); background: rgba(122,62,31,0.06); }
    .pill-unknown{ border-color: rgba(42,31,22,0.25); background: rgba(42,31,22,0.05); }

    .muted{ color: var(--ink2); font-size: 13px; }

    .divider{ height:1px; background: rgba(217,200,170,0.8); margin: 12px 0; }

    .effects{ display:grid; gap: 10px; margin-top: 10px; }

    .effect-line{ display:flex; gap: 10px; align-items:center; }

    .effect-text{
      flex:1;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(217,200,170,0.95);
      background: rgba(255,255,255,0.6);
      box-shadow: 0 1px 0 rgba(255,255,255,0.7) inset;
      min-height: 20px;
    }

    .hidden{
      color: transparent;
      text-shadow: 0 0 11px rgba(42,31,22,0.55);
      user-select: none;
    }

    .ing-card{ display:flex; gap: 12px; align-items:flex-start; flex-wrap: wrap; }

    .img{
      width: 190px;
      max-width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(217,200,170,0.95);
      background: rgba(255,255,255,0.6);
      box-shadow: var(--shadow2);
    }

    .img-sm{
      width: 56px;
      height: 56px;
      border-radius: 14px;
      border: 1px solid rgba(217,200,170,0.95);
      object-fit: cover;
      background: rgba(255,255,255,0.6);
      box-shadow: 0 10px 20px rgba(0,0,0,0.10);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(217,200,170,0.95);
      color: var(--ink);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      max-width: calc(100vw - 32px);
      display:none;
      z-index: 50;
      font-size: 14px;
    }
    .toast.good{ border-color: rgba(31,122,58,0.40); }
    .toast.bad{ border-color: rgba(139,29,44,0.35); }

    .mix-pics{ display:flex; gap: 10px; align-items:center; margin-top: 10px; }

    .mix-result{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(217,200,170,0.95);
      background: rgba(255,255,255,0.65);
    }

    .sigil{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing: 0.5px;
      font-size: 12px;
      color: rgba(42,31,22,0.55);
    }

    .hide-tools{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }

    details{
      border: 1px dashed rgba(217,200,170,0.95);
      border-radius: 14px;
      background: rgba(255,255,255,0.45);
      padding: 10px 12px;
    }
    details summary{
      cursor: pointer;
      font-weight: 700;
      color: rgba(42,31,22,0.85);
      list-style: none;
    }
    details summary::-webkit-details-marker{ display:none; }

    /* Satchel list with +/- counter, stays even at 0 */
    .satchel-list{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    .satchel-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(217,200,170,0.95);
      background: rgba(255,255,255,0.70);
      box-shadow: 0 8px 16px rgba(0,0,0,0.07);
    }
    .satchel-name{
      font-size: 16px;
      font-weight: 700;
      color: rgba(42,31,22,0.92);
      border: none;
      background: transparent;
      padding: 0;
      text-align:left;
      cursor:pointer;
      font-family: inherit;
    }
    .qty{
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }
    .qty .count{
      min-width: 34px;
      text-align:center;
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(217,200,170,0.95);
      background: rgba(255,255,255,0.75);
    }
    .qty button{
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 700;
      min-width: 42px;
    }

    /* Optional third ingredient UI */
    .optional{
      border: 1px dashed rgba(217,200,170,0.95);
      border-radius: 14px;
      background: rgba(255,255,255,0.45);
      padding: 10px 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>Field Alchemy Notes</h1>
        <div class="sub">A traveling page of tinctures, petals, powders, and strange little miracles.</div>
      </div>
      <div class="hide-tools">
        <button class="btn-quiet small" id="refreshBtn" title="Pulls in anything new that was prepared ahead of time.">Update Notes</button>
      </div>
    </div>

    <div class="card">
      <div class="label">Add Ingredient</div>
      <div class="muted">Write the mark you were given, then press Add.</div>
      <div class="row" style="margin-top:10px;">
        <input id="markInput" inputmode="numeric" placeholder="Mark" aria-label="Mark" />
        <button class="btn-primary" id="addBtn">Add</button>
        <button class="btn" id="openBtn">Open</button>
        <button class="btn-danger" id="closeBtn">Close Page</button>
      </div>

      <div class="divider"></div>

      <div class="label">Satchel</div>
      <div class="muted">What you have chosen to keep close at hand.</div>
      <div class="satchel-list" id="satchel"></div>

      <div class="row" style="margin-top:10px;">
        <button class="btn-danger small" id="clearSatchelBtn">Empty Satchel</button>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <div class="label">Mortar and Pestle</div>
        <div class="muted">Choose two, then Brew. If they share a nature, a concoction is born.</div>

        <div class="row" style="margin-top:10px;">
          <select id="mixA" style="min-width: 260px;"></select>
          <select id="mixB" style="min-width: 260px;"></select>
          <button class="btn-primary" id="brewBtn">Brew</button>
        </div>

        <div class="optional">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">Optional third ingredient</div>
            <label class="row" style="gap:8px;">
              <input type="checkbox" id="useThird" />
              <span class="muted">Include</span>
            </label>
          </div>
          <div class="row" style="margin-top:10px;">
            <select id="mixC" style="min-width: 260px;" disabled></select>
          </div>
          <div class="muted" style="margin-top:8px;">
            If included, it must also be in your satchel with enough quantity.
          </div>
        </div>

        <div class="mix-pics">
          <img class="img-sm" id="mixImgA" alt="First ingredient" />
          <img class="img-sm" id="mixImgB" alt="Second ingredient" />
          <img class="img-sm" id="mixImgC" alt="Third ingredient" style="display:none;" />
        </div>

        <div class="mix-result" id="mixResult">
          <div class="muted">No mixture yet.</div>
        </div>
      </div>

      <div class="card" id="ingredientCard" style="display:none;">
        <div class="label">Ingredient</div>
        <div class="ing-card">
          <img class="img" id="ingImage" alt="Ingredient" />
          <div style="flex:1; min-width: 240px;">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;">
              <div>
                <div style="font-size:20px; font-weight:700;" id="ingName"></div>
                <div style="margin-top:6px;">
                  <span class="pill" id="rarityPill">Unknown</span>
                </div>
              </div>
              <div class="row">
                <button class="btn small" id="revealRandomBtn">Reveal a Property</button>
                <button class="btn-danger small" id="resetRevealsBtn">Forget Properties</button>
              </div>
            </div>

            <div class="effects" id="effectsList"></div>

            <details style="margin-top:10px;">
              <summary>Keep Safe</summary>
              <div class="muted" style="margin-top:8px;">
                If you lose this device, export your notes and keep them somewhere safe.
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="btn small" id="exportBtn">Export Notes</button>
                <button class="btn small" id="importBtn">Import Notes</button>
                <button class="btn-danger small" id="wipeBtn">Burn All Notes</button>
              </div>
              <textarea id="saveBox" rows="6" style="width:100%; margin-top:10px;" placeholder="Notes appear here for export or import."></textarea>
              <div class="muted sigil" style="margin-top:8px;">
                This page never sends your properties anywhere. It stays in the device, unless you export it.
              </div>
            </details>

          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted" id="statusText">Waiting for ink to dry.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // Connection settings
  const SUPABASE_URL = "https://yjelzojkirlzdnwftupz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqZWx6b2praXJsemRud2Z0dXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTk0MTEsImV4cCI6MjA4NTkzNTQxMX0.5TCIyj5cAUlCAmNc2yBOIdpfNoN4NLqOOfcnBVbCzZA";

  const REST_BASE = `${SUPABASE_URL}/rest/v1`;
  const INGREDIENTS_ENDPOINT = `${REST_BASE}/ingredients?select=id,name,effect_1,effect_2,effect_3,effect_4,image_path,rarity,notes&order=id.asc`;
  const INGREDIENT_BY_MARK = (mark) => `${REST_BASE}/ingredients?select=id,name,effect_1,effect_2,effect_3,effect_4,image_path,rarity,notes&id=eq.${encodeURIComponent(mark)}&limit=1`;
  const PUBLIC_STORAGE_BASE = `${SUPABASE_URL}/storage/v1/object/public/`;

  // Local notes
  // satchel is a map { [id]: quantityNumber }, and entries remain even at 0
  const LOCAL_KEY = "field_alchemy_notes_v5";
  function loadLocal() {
    const raw = localStorage.getItem(LOCAL_KEY);
    if (!raw) return { reveals: {}, satchel: {} };
    try {
      const parsed = JSON.parse(raw);
      const sat = (parsed && typeof parsed.satchel === "object" && parsed.satchel) ? parsed.satchel : {};
      const cleanedSatchel = {};
      for (const [k,v] of Object.entries(sat)) {
        const n = Number(v);
        if (Number.isFinite(n) && n >= 0) cleanedSatchel[String(k)] = Math.floor(n);
      }
      return {
        reveals: (parsed && typeof parsed.reveals === "object" && parsed.reveals) ? parsed.reveals : {},
        satchel: cleanedSatchel
      };
    } catch {
      return { reveals: {}, satchel: {} };
    }
  }
  function saveLocal() {
    localStorage.setItem(LOCAL_KEY, JSON.stringify(LOCAL));
  }

  let LOCAL = loadLocal();
  let REVEALS = LOCAL.reveals;          // { [id]: [bool,bool,bool,bool] }
  let SATCHEL = LOCAL.satchel;          // { [id]: qty }, qty can be 0

  // In-memory cache
  let ING_BY_ID = {};                   // id -> row
  const el = (id) => document.getElementById(id);

  function headers() {
    return {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    };
  }

  function toast(msg, kind) {
    const t = el("toast");
    t.className = "toast";
    if (kind === "good") t.classList.add("good");
    if (kind === "bad") t.classList.add("bad");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => { t.style.display = "none"; }, 2200);
  }

  function rarityClass(r) {
    const v = String(r || "").trim().toLowerCase();
    if (!v) return "pill-unknown";
    if (v.includes("rare") || v.includes("uncommon") || v.includes("legend")) return "pill-rare";
    return "pill-common";
  }

  function rarityLabel(r) {
    const v = String(r || "").trim();
    return v ? v : "Unknown";
  }

  function getImageUrl(image_path) {
    if (!image_path) return "";
    return `${PUBLIC_STORAGE_BASE}${image_path}`;
  }

  function placeholderImageDataUri(label) {
    const svg =
      `<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'>` +
      `<rect width='100%' height='100%' fill='%23ffffff'/>` +
      `<rect x='10' y='10' width='236' height='236' rx='22' ry='22' fill='%23f6f0e3' stroke='%23d9c8aa' stroke-width='4'/>` +
      `<text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' fill='%237a3e1f' font-size='18' font-family='Segoe Print,Bradley Hand,cursive'>${label}</text>` +
      `</svg>`;
    return "data:image/svg+xml," + encodeURIComponent(svg);
  }

  async function fetchAllIngredients() {
    el("statusText").textContent = "Turning pages...";
    try {
      const res = await fetch(INGREDIENTS_ENDPOINT, { headers: headers() });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }
      const rows = await res.json();

      ING_BY_ID = {};
      for (const r of rows) {
        const idStr = String(r.id);
        ING_BY_ID[idStr] = r;
        if (!REVEALS[idStr]) REVEALS[idStr] = [false, false, false, false];
      }
      saveLocal();

      // Remove satchel entries for missing ingredients, but keep 0 entries for valid ones
      for (const idStr of Object.keys(SATCHEL)) {
        if (!ING_BY_ID[idStr]) delete SATCHEL[idStr];
      }
      LOCAL.satchel = SATCHEL;
      saveLocal();

      renderSatchel();
      fillMixChoices();
      updateMixPictures();
      el("statusText").textContent = "Notes updated.";
    } catch (e) {
      el("statusText").textContent = "Could not update notes.";
      toast("The ink smudged. Try again.", "bad");
      console.error(e);
    }
  }

  async function fetchOne(mark) {
    const res = await fetch(INGREDIENT_BY_MARK(mark), { headers: headers() });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    const rows = await res.json();
    return rows?.[0] || null;
  }

  function setRarityPill(row) {
    const pill = el("rarityPill");
    pill.className = "pill " + rarityClass(row?.rarity);
    pill.textContent = rarityLabel(row?.rarity);
  }

  function renderIngredient(idStr) {
    const row = ING_BY_ID[idStr];
    if (!row) {
      toast("That mark is not in your notes.", "bad");
      return;
    }

    el("ingredientCard").style.display = "block";
    el("ingName").textContent = row.name || "Unknown Ingredient";
    setRarityPill(row);

    const imgUrl = getImageUrl(row.image_path);
    el("ingImage").src = imgUrl || placeholderImageDataUri("No sketch");

    const effects = [row.effect_1, row.effect_2, row.effect_3, row.effect_4].map(v => v || "");
    const revealed = REVEALS[idStr] || [false,false,false,false];

    const list = el("effectsList");
    list.innerHTML = "";

    effects.forEach((eff, idx) => {
      const line = document.createElement("div");
      line.className = "effect-line";

      const label = document.createElement("div");
      label.className = "pill";
      label.textContent = `Property ${idx + 1}`;

      const text = document.createElement("div");
      text.className = "effect-text";
      text.textContent = eff || "(blank)";
      if (!revealed[idx]) text.classList.add("hidden");

      const btn = document.createElement("button");
      btn.className = "btn small";
      btn.textContent = revealed[idx] ? "Known" : "Reveal";
      btn.disabled = revealed[idx];
      btn.addEventListener("click", () => {
        REVEALS[idStr][idx] = true;
        saveLocal();
        renderIngredient(idStr);
        toast("A property reveals itself.", "good");
      });

      line.appendChild(label);
      line.appendChild(text);
      line.appendChild(btn);
      list.appendChild(line);
    });

    el("revealRandomBtn").onclick = () => {
      const hidden = [];
      for (let i = 0; i < 4; i++) if (!REVEALS[idStr][i]) hidden.push(i);
      if (hidden.length === 0) {
        toast("Nothing more to learn here.", "good");
        return;
      }
      const pick = hidden[Math.floor(Math.random() * hidden.length)];
      REVEALS[idStr][pick] = true;
      saveLocal();
      renderIngredient(idStr);
      toast("A property reveals itself.", "good");
    };

    el("resetRevealsBtn").onclick = () => {
      REVEALS[idStr] = [false,false,false,false];
      saveLocal();
      renderIngredient(idStr);
      toast("Properties forgotten.", "bad");
    };
  }

  function closeIngredient() { el("ingredientCard").style.display = "none"; }

  function satchelIdsAll() {
    const ids = Object.keys(SATCHEL).filter(id => ING_BY_ID[id]); // include zeros
    ids.sort((a,b) => Number(a) - Number(b));
    return ids;
  }

  function satchelIdsAvailable() {
    const ids = Object.keys(SATCHEL).filter(id => ING_BY_ID[id] && (Number(SATCHEL[id]) || 0) > 0);
    ids.sort((a,b) => Number(a) - Number(b));
    return ids;
  }

  function setQty(idStr, qty) {
    const q = Math.max(0, Math.floor(Number(qty) || 0));
    SATCHEL[String(idStr)] = q; // keep even if 0
    LOCAL.satchel = SATCHEL;
    saveLocal();
  }

  function renderSatchel() {
    const wrap = el("satchel");
    wrap.innerHTML = "";

    const ids = satchelIdsAll();
    if (ids.length === 0) {
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = "Your satchel is empty.";
      wrap.appendChild(d);
      fillMixChoices();
      updateMixPictures();
      return;
    }

    for (const idStr of ids) {
      const row = ING_BY_ID[idStr];
      const name = row?.name || "Unknown";
      const qty = Number(SATCHEL[idStr]) || 0;

      const line = document.createElement("div");
      line.className = "satchel-row";

      const nameBtn = document.createElement("button");
      nameBtn.type = "button";
      nameBtn.className = "satchel-name";
      nameBtn.textContent = name;
      nameBtn.addEventListener("click", () => renderIngredient(idStr));

      const qtyWrap = document.createElement("div");
      qtyWrap.className = "qty";

      const minus = document.createElement("button");
      minus.type = "button";
      minus.className = "btn small";
      minus.textContent = "-";
      minus.addEventListener("click", () => {
        const next = qty - 1;
        setQty(idStr, next);
        renderSatchel();
        fillMixChoices();
        updateMixPictures();
        toast("Noted.", next < qty ? "bad" : "good");
      });

      const count = document.createElement("div");
      count.className = "count";
      count.textContent = String(qty);

      const plus = document.createElement("button");
      plus.type = "button";
      plus.className = "btn small";
      plus.textContent = "+";
      plus.addEventListener("click", () => {
        setQty(idStr, qty + 1);
        renderSatchel();
        fillMixChoices();
        updateMixPictures();
        toast("Noted.", "good");
      });

      qtyWrap.appendChild(minus);
      qtyWrap.appendChild(count);
      qtyWrap.appendChild(plus);

      line.appendChild(nameBtn);
      line.appendChild(qtyWrap);
      wrap.appendChild(line);
    }

    fillMixChoices();
    updateMixPictures();
  }

  function fillMixChoices() {
    const a = el("mixA");
    const b = el("mixB");
    const c = el("mixC");

    const ids = satchelIdsAvailable(); // only >0 for brewing
    const all = satchelIdsAll();       // for showing pictures when empty

    if (ids.length < 2) {
      a.innerHTML = "";
      b.innerHTML = "";
      c.innerHTML = "";
      el("mixResult").innerHTML = `<div class="muted">Keep at least two ingredients in your satchel to brew.</div>`;
      // Still set pictures to something reasonable
      const pick = all[0];
      const row = pick ? ING_BY_ID[pick] : null;
      el("mixImgA").src = getImageUrl(row?.image_path) || placeholderImageDataUri("?");
      el("mixImgB").src = placeholderImageDataUri("?");
      el("mixImgC").style.display = el("useThird").checked ? "block" : "none";
      el("mixImgC").src = placeholderImageDataUri("?");
      return;
    }

    const opts = ids.map(idStr => {
      const name = ING_BY_ID[idStr]?.name || "Unknown";
      const qty = Number(SATCHEL[idStr]) || 0;
      return `<option value="${escapeHtml(idStr)}">${escapeHtml(name)} (${qty})</option>`;
    }).join("");

    const prevA = a.value;
    const prevB = b.value;
    const prevC = c.value;

    a.innerHTML = opts;
    b.innerHTML = opts;
    c.innerHTML = opts;

    a.value = ids.includes(prevA) ? prevA : ids[0];
    b.value = ids.includes(prevB) ? prevB : ids[1];

    if (a.value === b.value) {
      b.value = ids.find(x => x !== a.value) || ids[1];
    }

    c.value = ids.includes(prevC) ? prevC : ids.find(x => x !== a.value && x !== b.value) || ids[0];

    if (el("useThird").checked) {
      if (c.value === a.value || c.value === b.value) {
        c.value = ids.find(x => x !== a.value && x !== b.value) || c.value;
      }
    }

    updateMixPictures();
  }

  function updateMixPictures() {
    const aId = el("mixA").value;
    const bId = el("mixB").value;
    const useThird = el("useThird").checked;
    const cId = useThird ? el("mixC").value : null;

    const aRow = ING_BY_ID[aId];
    const bRow = ING_BY_ID[bId];
    const cRow = cId ? ING_BY_ID[cId] : null;

    el("mixImgA").src = getImageUrl(aRow?.image_path) || placeholderImageDataUri("?");
    el("mixImgB").src = getImageUrl(bRow?.image_path) || placeholderImageDataUri("?");

    const cEl = el("mixImgC");
    if (useThird) {
      cEl.style.display = "block";
      cEl.src = getImageUrl(cRow?.image_path) || placeholderImageDataUri("?");
      cEl.alt = cRow?.name || "Ingredient";
    } else {
      cEl.style.display = "none";
    }

    el("mixImgA").alt = aRow?.name || "Ingredient";
    el("mixImgB").alt = bRow?.name || "Ingredient";
  }

  function computeShared(ids) {
    const rows = ids.map(id => ING_BY_ID[id]).filter(Boolean);
    if (rows.length < 2) return [];

    const sets = rows.map(r => new Set([r.effect_1, r.effect_2, r.effect_3, r.effect_4].filter(Boolean)));
    let shared = sets[0];
    for (let i = 1; i < sets.length; i++) {
      shared = new Set([...shared].filter(x => sets[i].has(x)));
    }
    return [...shared];
  }

  function revealSharedAutomatically(ids, shared) {
    for (const idStr of ids) {
      const row = ING_BY_ID[idStr];
      if (!row) continue;

      const effs = [row.effect_1, row.effect_2, row.effect_3, row.effect_4];
      if (!REVEALS[idStr]) REVEALS[idStr] = [false,false,false,false];

      for (let i = 0; i < 4; i++) {
        if (shared.includes(effs[i])) REVEALS[idStr][i] = true;
      }
    }
    saveLocal();
  }

  function canSpend(ids) {
    // Count how many of each id are needed
    const needed = {};
    for (const id of ids) needed[id] = (needed[id] || 0) + 1;

    for (const [id, n] of Object.entries(needed)) {
      const have = Number(SATCHEL[id]) || 0;
      if (have < n) return false;
    }
    return true;
  }

  function spend(ids) {
    const needed = {};
    for (const id of ids) needed[id] = (needed[id] || 0) + 1;
    for (const [id, n] of Object.entries(needed)) {
      setQty(id, (Number(SATCHEL[id]) || 0) - n);
    }
  }

  function brew() {
    const aId = el("mixA").value;
    const bId = el("mixB").value;
    const useThird = el("useThird").checked;
    const cId = useThird ? el("mixC").value : null;

    const ids = [aId, bId].filter(Boolean);
    if (useThird && cId) ids.push(cId);

    // Must all be distinct for three-ingredient brew, unless you want duplicates
    if (useThird && (aId === bId || aId === cId || bId === cId)) {
      el("mixResult").innerHTML = `
        <div style="color:var(--warn); font-weight:700;">Choose different ingredients.</div>
        <div class="muted" style="margin-top:6px;">The third ingredient should be different.</div>
      `;
      toast("Choose different ingredients.", "bad");
      return;
    }

    updateMixPictures();

    if (ids.length < 2) {
      el("mixResult").innerHTML = `<div class="muted">Keep at least two ingredients in your satchel to brew.</div>`;
      return;
    }

    if (!canSpend(ids)) {
      el("mixResult").innerHTML = `
        <div style="color:var(--warn); font-weight:700;">Not enough in the satchel.</div>
        <div class="muted" style="margin-top:6px;">One of the chosen ingredients is missing.</div>
      `;
      toast("Not enough in the satchel.", "bad");
      return;
    }

    const shared = computeShared(ids);

    // Consume ingredients regardless of outcome (matches your earlier consumption behavior)
    spend(ids);
    renderSatchel();
    fillMixChoices();
    updateMixPictures();

    if (shared.length === 0) {
      el("mixResult").innerHTML = `
        <div style="color:var(--warn); font-weight:700;">The mixture fizzles.</div>
        <div class="muted" style="margin-top:6px;">Nothing in common, nothing takes hold.</div>
      `;
      toast("The mixture fizzles.", "bad");
      return;
    }

    revealSharedAutomatically(ids, shared);

    const effectText = shared.join(", ");
    el("mixResult").innerHTML = `
      <div style="color:var(--good); font-weight:700;">Made Concoction of ${escapeHtml(effectText)}</div>
      <div class="muted" style="margin-top:6px;">The shared nature has been noted.</div>
    `;
    toast("A concoction is born.", "good");
  }

  // Export / Import
  function exportNotes() {
    const payload = { reveals: REVEALS, satchel: SATCHEL };
    el("saveBox").value = JSON.stringify(payload, null, 2);
    toast("Notes copied to the box.", "good");
  }

  function importNotes() {
    try {
      const parsed = JSON.parse(el("saveBox").value);
      if (!parsed || typeof parsed !== "object") throw new Error("Bad");
      REVEALS = (parsed.reveals && typeof parsed.reveals === "object") ? parsed.reveals : {};
      const sat = (parsed && typeof parsed.satchel === "object" && parsed.satchel) ? parsed.satchel : {};
      const cleaned = {};
      for (const [k,v] of Object.entries(sat)) {
        const n = Number(v);
        if (Number.isFinite(n) && n >= 0) cleaned[String(k)] = Math.floor(n);
      }
      SATCHEL = cleaned;

      LOCAL = { reveals: REVEALS, satchel: SATCHEL };
      saveLocal();
      renderSatchel();
      fillMixChoices();
      updateMixPictures();
      toast("Notes restored.", "good");
    } catch {
      toast("Those notes do not make sense.", "bad");
    }
  }

  function burnAll() {
    if (!confirm("Burn all notes on this device?")) return;
    LOCAL = { reveals: {}, satchel: {} };
    REVEALS = LOCAL.reveals;
    SATCHEL = LOCAL.satchel;
    saveLocal();
    closeIngredient();
    renderSatchel();
    fillMixChoices();
    updateMixPictures();
    el("mixResult").innerHTML = `<div class="muted">No mixture yet.</div>`;
    toast("Ashes and silence.", "bad");
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[c]));
  }

  async function addToSatchelFromMark(mark) {
    const clean = String(mark || "").trim();
    if (!clean) return;

    if (!ING_BY_ID[clean]) {
      try {
        const row = await fetchOne(clean);
        if (!row) {
          toast("That mark is unknown.", "bad");
          return;
        }
        ING_BY_ID[clean] = row;
        if (!REVEALS[clean]) REVEALS[clean] = [false, false, false, false];
        saveLocal();
      } catch {
        toast("Could not read that mark.", "bad");
        return;
      }
    }

    const current = Number(SATCHEL[clean]);
    const qty = Number.isFinite(current) ? current : 0;
    setQty(clean, qty + 1);

    renderSatchel();
    fillMixChoices();
    updateMixPictures();
    toast("Added to satchel.", "good");

    renderIngredient(clean);
  }

  // Wire events
  el("refreshBtn").addEventListener("click", fetchAllIngredients);

  el("addBtn").addEventListener("click", () => addToSatchelFromMark(el("markInput").value));
  el("openBtn").addEventListener("click", () => {
    const mark = el("markInput").value.trim();
    if (!mark) return;
    if (!ING_BY_ID[mark]) {
      toast("Add it first.", "bad");
      return;
    }
    renderIngredient(mark);
  });
  el("closeBtn").addEventListener("click", closeIngredient);

  el("clearSatchelBtn").addEventListener("click", () => {
    if (!confirm("Empty your satchel on this device?")) return;
    SATCHEL = {};
    LOCAL.satchel = SATCHEL;
    saveLocal();
    renderSatchel();
    fillMixChoices();
    updateMixPictures();
    el("mixResult").innerHTML = `<div class="muted">No mixture yet.</div>`;
    toast("Satchel emptied.", "bad");
  });

  el("mixA").addEventListener("change", updateMixPictures);
  el("mixB").addEventListener("change", updateMixPictures);
  el("useThird").addEventListener("change", () => {
    const on = el("useThird").checked;
    el("mixC").disabled = !on;
    el("mixImgC").style.display = on ? "block" : "none";
    fillMixChoices();
    updateMixPictures();
  });
  el("mixC").addEventListener("change", updateMixPictures);

  el("brewBtn").addEventListener("click", brew);

  el("exportBtn").addEventListener("click", exportNotes);
  el("importBtn").addEventListener("click", importNotes);
  el("wipeBtn").addEventListener("click", burnAll);

  el("markInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") addToSatchelFromMark(el("markInput").value);
  });

  // Initial
  el("mixImgA").src = placeholderImageDataUri("?");
  el("mixImgB").src = placeholderImageDataUri("?");
  el("mixImgC").src = placeholderImageDataUri("?");
  fetchAllIngredients();
  renderSatchel();
  fillMixChoices();
  updateMixPictures();
</script>
</body>
</html>
